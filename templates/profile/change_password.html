{% extends "base.html" %}

{% block page_title %}Change Password{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="content-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-key"></i>
                        Change Password
                    </h5>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
                        role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <form method="POST" class="password-form">
                        <div class="form-group mb-3">
                            <label for="current_password" class="form-label">Current Password *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input type="password" class="form-control" id="current_password"
                                    name="current_password" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="new_password" class="form-label">New Password *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input type="password" class="form-control" id="new_password" name="new_password"
                                    required minlength="6">
                                <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-strength">
                                <div class="strength-bar">
                                    <div class="strength-fill" id="strengthFill"></div>
                                </div>
                                <small class="strength-text" id="strengthText">Password strength</small>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label for="confirm_password" class="form-label">Confirm New Password *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input type="password" class="form-control" id="confirm_password"
                                    name="confirm_password" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted" id="passwordMatch"></small>
                        </div>

                        <div class="password-requirements mb-4">
                            <p class="mb-2"><strong>Password Requirements:</strong></p>
                            <ul class="requirements-list">
                                <li id="length" class="requirement">
                                    <i class="fas fa-times text-danger"></i>
                                    At least 6 characters
                                </li>
                                <li id="lowercase" class="requirement">
                                    <i class="fas fa-times text-danger"></i>
                                    One lowercase letter
                                </li>
                                <li id="uppercase" class="requirement">
                                    <i class="fas fa-times text-danger"></i>
                                    One uppercase letter
                                </li>
                                <li id="number" class="requirement">
                                    <i class="fas fa-times text-danger"></i>
                                    One number
                                </li>
                            </ul>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                                <i class="fas fa-save"></i>
                                Change Password
                            </button>
                            <a href="{{ url_for('profile.settings') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i>
                                Back to Settings
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const currentPasswordInput = document.getElementById('current_password');
        const newPasswordInput = document.getElementById('new_password');
        const confirmPasswordInput = document.getElementById('confirm_password');
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');
        const passwordMatch = document.getElementById('passwordMatch');
        const changePasswordBtn = document.getElementById('changePasswordBtn');

        // Password visibility toggles
        setupPasswordToggle('toggleCurrentPassword', 'current_password');
        setupPasswordToggle('toggleNewPassword', 'new_password');
        setupPasswordToggle('toggleConfirmPassword', 'confirm_password');

        function setupPasswordToggle(toggleId, inputId) {
            const toggle = document.getElementById(toggleId);
            const input = document.getElementById(inputId);

            toggle.addEventListener('click', function () {
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);

                const icon = toggle.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
        }

        // Password strength checker
        newPasswordInput.addEventListener('input', function () {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            updatePasswordStrength(strength);
            checkRequirements(password);
            validateForm();
        });

        // Confirm password checker
        confirmPasswordInput.addEventListener('input', function () {
            checkPasswordMatch();
            validateForm();
        });

        function calculatePasswordStrength(password) {
            let score = 0;

            if (password.length >= 6) score += 1;
            if (password.length >= 10) score += 1;
            if (/[a-z]/.test(password)) score += 1;
            if (/[A-Z]/.test(password)) score += 1;
            if (/[0-9]/.test(password)) score += 1;
            if (/[^A-Za-z0-9]/.test(password)) score += 1;

            return Math.min(score / 6, 1);
        }

        function updatePasswordStrength(strength) {
            const percentage = strength * 100;
            strengthFill.style.width = percentage + '%';

            if (percentage < 30) {
                strengthFill.style.backgroundColor = '#ef4444';
                strengthText.textContent = 'Weak password';
                strengthText.className = 'strength-text text-danger';
            } else if (percentage < 60) {
                strengthFill.style.backgroundColor = '#f59e0b';
                strengthText.textContent = 'Fair password';
                strengthText.className = 'strength-text text-warning';
            } else if (percentage < 80) {
                strengthFill.style.backgroundColor = '#06b6d4';
                strengthText.textContent = 'Good password';
                strengthText.className = 'strength-text text-info';
            } else {
                strengthFill.style.backgroundColor = '#10b981';
                strengthText.textContent = 'Strong password';
                strengthText.className = 'strength-text text-success';
            }
        }

        function checkRequirements(password) {
            const requirements = {
                length: password.length >= 6,
                lowercase: /[a-z]/.test(password),
                uppercase: /[A-Z]/.test(password),
                number: /[0-9]/.test(password)
            };

            Object.keys(requirements).forEach(req => {
                const element = document.getElementById(req);
                const icon = element.querySelector('i');
                const isMet = requirements[req];

                if (isMet) {
                    icon.className = 'fas fa-check text-success';
                    element.classList.add('met');
                } else {
                    icon.className = 'fas fa-times text-danger';
                    element.classList.remove('met');
                }
            });
        }

        function checkPasswordMatch() {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (confirmPassword === '') {
                passwordMatch.textContent = '';
                passwordMatch.className = 'form-text text-muted';
            } else if (newPassword === confirmPassword) {
                passwordMatch.textContent = 'Passwords match';
                passwordMatch.className = 'form-text text-success';
            } else {
                passwordMatch.textContent = 'Passwords do not match';
                passwordMatch.className = 'form-text text-danger';
            }
        }

        function validateForm() {
            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            const isValid = currentPassword &&
                newPassword &&
                newPassword.length >= 6 &&
                confirmPassword &&
                newPassword === confirmPassword;

            changePasswordBtn.disabled = !isValid;
        }

        // Form submission
        document.querySelector('.password-form').addEventListener('submit', function (e) {
            e.preventDefault();

            changePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing Password...';
            changePasswordBtn.disabled = true;

            // Simulate form submission (replace with actual form submission)
            setTimeout(() => {
                this.submit();
            }, 1000);
        });
    });
</script>

<style>
    .password-strength {
        margin-top: 8px;
    }

    .strength-bar {
        height: 4px;
        background-color: var(--gray-200);
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 4px;
    }

    .strength-fill {
        height: 100%;
        width: 0%;
        transition: width 0.3s ease, background-color 0.3s ease;
        border-radius: 2px;
    }

    .strength-text {
        font-size: 12px;
        margin: 0;
    }

    .password-requirements {
        background: var(--gray-100);
        padding: 16px;
        border-radius: 8px;
    }

    .requirements-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .requirement {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        font-size: 14px;
        transition: color 0.3s ease;
    }

    .requirement.met {
        color: var(--success-color);
    }

    .requirement i {
        width: 16px;
        text-align: center;
    }

    .input-group-text {
        background-color: var(--gray-100);
        border-color: var(--gray-300);
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
{% endblock %}