{% extends "base.html" %}

{% block page_title %}Profile{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="row">
        <!-- Profile Information -->
        <div class="col-lg-4 mb-4">
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img src="{{ current_user.avatar_url }}" alt="{{ current_user.username }}" id="profileAvatar">
                        <div class="avatar-overlay">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <h4 class="profile-name">{{ current_user.username|title|replace('_', ' ') }}</h4>
                    <p class="profile-email">{{ current_user.email }}</p>
                    <p class="profile-joined">Member since {{ current_user.created_at.strftime('%B %Y') }}</p>
                </div>

                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-number">{{ user_projects|length }}</div>
                        <div class="stat-label">Projects</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ recent_activities|length }}</div>
                        <div class="stat-label">Activities</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ current_user.project_assignments|length }}</div>
                        <div class="stat-label">Assignments</div>
                    </div>
                </div>

                <div class="profile-actions">
                    <a href="{{ url_for('profile.edit_profile') }}" class="btn btn-primary">
                        <i class="fas fa-edit"></i>
                        Edit Profile
                    </a>
                    <a href="{{ url_for('profile.settings') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-cog"></i>
                        Settings
                    </a>
                </div>
            </div>
        </div>

        <!-- Projects and Activities -->
        <div class="col-lg-8">
            <!-- User Projects -->
            <div class="content-card mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-project-diagram"></i>
                        My Projects
                    </h5>
                    <a href="{{ url_for('profile.projects') }}" class="btn btn-link btn-sm">View All</a>
                </div>
                <div class="card-body">
                    {% if user_projects %}
                    <div class="row">
                        {% for project in user_projects[:4] %}
                        <div class="col-md-6 mb-3">
                            <div class="project-card-small">
                                <div class="project-header-small">
                                    <div class="project-icon-small {{ project.department|lower }}">
                                        <i class="{{ get_project_icon(project.name) }}"></i>
                                    </div>
                                    <div class="project-priority-small">
                                        <span class="badge badge-{{ get_priority_color(project.priority) }}">{{
                                            project.priority }}</span>
                                    </div>
                                </div>
                                <h6 class="project-title-small">{{ project.name }}</h6>
                                <p class="project-subtitle-small">{{ project.description[:50] }}...</p>
                                <div class="progress-bar-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{ project.progress }}%"></div>
                                    </div>
                                    <span class="progress-percentage">{{ project.progress }}%</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-project-diagram"></i>
                        <h6>No Projects Yet</h6>
                        <p>You haven't been assigned to any projects yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="content-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-clock"></i>
                        Recent Activity
                    </h5>
                    <a href="{{ url_for('profile.activities') }}" class="btn btn-link btn-sm">View All</a>
                </div>
                <div class="card-body">
                    {% if recent_activities %}
                    <div class="activity-timeline">
                        {% for activity in recent_activities %}
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <span class="timeline-action">{{ activity.action }}</span>
                                    <span class="timeline-time">{{ time_ago(activity.created_at) }}</span>
                                </div>
                                <p class="timeline-description">{{ activity.description }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-clock"></i>
                        <h6>No Recent Activity</h6>
                        <p>Your activity will appear here.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Avatar Upload Modal -->
<div class="modal fade" id="avatarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Avatar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="avatarUrl" class="form-label">Avatar URL</label>
                    <input type="url" class="form-control" id="avatarUrl" placeholder="Enter image URL">
                    <small class="form-text text-muted">Enter a URL to an image or use a service like
                        ui-avatars.com</small>
                </div>
                <div class="avatar-preview">
                    <img src="{{ current_user.avatar_url }}" alt="Preview" id="avatarPreview">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateAvatar">Update Avatar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Avatar update functionality
        const avatarOverlay = document.querySelector('.avatar-overlay');
        const avatarModal = new bootstrap.Modal(document.getElementById('avatarModal'));
        const avatarUrlInput = document.getElementById('avatarUrl');
        const avatarPreview = document.getElementById('avatarPreview');
        const updateAvatarBtn = document.getElementById('updateAvatar');

        avatarOverlay.addEventListener('click', function () {
            avatarModal.show();
        });

        avatarUrlInput.addEventListener('input', function () {
            if (this.value) {
                avatarPreview.src = this.value;
            }
        });

        updateAvatarBtn.addEventListener('click', function () {
            const avatarUrl = avatarUrlInput.value;
            if (!avatarUrl) return;

            fetch('/profile/api/avatar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ avatar_url: avatarUrl })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        // Update avatar in the page
                        document.getElementById('profileAvatar').src = avatarUrl;
                        avatarModal.hide();
                        location.reload(); // Refresh to update all avatar instances
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating avatar');
                });
        });
    });
</script>
{% endblock %}